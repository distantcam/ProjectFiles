# Testing Guide for ProjectFilesGenerator

## Overview

This project uses **snapshot testing** via [Verify.SourceGenerators](https://github.com/VerifyTests/Verify.SourceGenerators) to ensure the source generator produces correct output.

## Why Snapshot Testing?

Traditional unit testing for source generators requires:
```csharp
// âŒ Complex, brittle assertions
Assert.Contains("public static string ConfigJson", generatedCode);
Assert.Contains("namespace ProjectFiles", generatedCode);
Assert.Contains("=> \"config.json\"", generatedCode);
// ... dozens more assertions
```

Snapshot testing is simpler:
```csharp
// âœ… One line, verifies everything
return TestHelper.Verify(projectContent, "config.json");
```

## Test Structure

```
ProjectFilesGenerator.Tests/
â”œâ”€â”€ ProjectFilesGenerator.Tests.csproj    (Test project)
â”œâ”€â”€ ProjectFilesSourceGeneratorTests.cs   (All test cases)
â”œâ”€â”€ TestHelper.cs                          (Test utilities)
â”œâ”€â”€ ModuleInitializer.cs                   (Verify setup)
â”œâ”€â”€ README.md                              (Project docs)
â””â”€â”€ Snapshots/                             (Approved outputs)
    â””â”€â”€ ProjectFilesSourceGeneratorTests/
        â”œâ”€â”€ GeneratesCorrectCodeForSimpleFile.verified.txt
        â”œâ”€â”€ GeneratesCorrectCodeForNestedDirectories.verified.txt
        â””â”€â”€ ... (one per test)
```

## Running Tests

### Quick Start

```bash
# Run all tests
cd ProjectFilesGenerator.Tests
dotnet test

# Run specific test
dotnet test --filter GeneratesCorrectCodeForSimpleFile

# Verbose output
dotnet test --logger "console;verbosity=detailed"
```

### In JetBrains Rider

1. **Run All Tests**
   - Right-click on `ProjectFilesGenerator.Tests` project
   - Select "Run Unit Tests"
   - Or press `Ctrl+U, R`

2. **Run Single Test**
   - Click the green play button next to the test method
   - Or place cursor in test and press `Ctrl+U, R`

3. **Debug Test**
   - Click the bug icon next to the test
   - Or place cursor in test and press `Ctrl+U, D`

4. **View Test Results**
   - Open Unit Tests window (View â†’ Tool Windows â†’ Unit Tests)
   - See pass/fail status and timing

### In Visual Studio

1. Open Test Explorer (Test â†’ Test Explorer)
2. Click "Run All Tests"
3. Or right-click individual tests

## Understanding Test Output

### Test Passes âœ…

```
Test passed: GeneratesCorrectCodeForSimpleFile
Duration: 234ms
```

The generated code matches the approved snapshot.

### Test Fails âŒ

```
Test failed: GeneratesCorrectCodeForSimpleFile
Expected: config.json
Received: config-new.json
```

The generated code differs from the snapshot. Verify shows you:
- **Left side**: Expected (from `.verified.txt`)
- **Right side**: Actual (from `.received.txt`)

## Workflow: Adding New Tests

### Step 1: Write Test

```csharp
[Fact]
public Task GeneratesCorrectCodeForMyScenario()
{
    var projectContent = """
        <Project Sdk="Microsoft.NET.Sdk">
          <ItemGroup>
            <None Update="myfile.txt">
              <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
          </ItemGroup>
        </Project>
        """;

    return TestHelper.Verify(projectContent, "myfile.txt");
}
```

### Step 2: Run Test (First Time)

```bash
dotnet test --filter GeneratesCorrectCodeForMyScenario
```

The test will **fail** on first run because no snapshot exists yet.

### Step 3: Review Generated Output

A new file appears:
```
Snapshots/ProjectFilesSourceGeneratorTests/
â””â”€â”€ GeneratesCorrectCodeForMyScenario.received.txt
```

Open and review the contents:
```json
{
  Diagnostics: [],
  GeneratedSources: [
    {
      Source: {
        Lines: [
          // <auto-generated/>,
          namespace ProjectFiles;,
          public static partial class ProjectFiles,
          {,
              public static string MyfileTxt => "myfile.txt";,
          }
        ]
      }
    }
  ]
}
```

### Step 4: Accept or Reject

**If output is correct:**

**In Rider:**
1. Diff tool opens automatically
2. Review the output
3. Click "Accept" button
4. File renamed to `.verified.txt`

**Manually:**
```bash
# Rename .received.txt to .verified.txt
mv Snapshots/.../GeneratesCorrectCodeForMyScenario.received.txt \
   Snapshots/.../GeneratesCorrectCodeForMyScenario.verified.txt
```

**If output is incorrect:**
- Fix the generator code
- Rerun the test
- Delete the `.received.txt` file

### Step 5: Commit Snapshot

```bash
git add Snapshots/
git commit -m "Add test for my scenario"
```

## Workflow: Updating Generator

### Scenario: You modify generator logic

1. **Run tests** - they will fail
   ```bash
   dotnet test
   ```

2. **Review diffs** - Verify shows what changed
   - Does the new output look correct?
   - Are the changes intentional?

3. **Accept or reject changes:**

   **Accept (output is correct):**
   - In Rider: Click "Accept" in diff viewer
   - Manually: Rename `.received.txt` to `.verified.txt`
   - Commit updated snapshots

   **Reject (output is wrong):**
   - Fix the generator
   - Rerun tests
   - Repeat until correct

## Test Categories

### âœ… Basic Tests
- Single file
- Multiple files
- Different file types (None, Content)

### âœ… Directory Tests
- Nested directories
- Multiple levels
- Empty directories

### âœ… Pattern Tests
- Recursive globs (`**\*.*`)
- Wildcards (`*.json`)
- Specific patterns

### âœ… Edge Cases
- Special characters in names
- Files starting with numbers
- C# keywords as names
- No files marked for copy

### âœ… Integration Tests
- Complex hierarchies
- Mixed patterns
- Real-world scenarios

## Common Scenarios

### Scenario 1: All Tests Fail After Refactoring

**Cause**: You changed how code is generated

**Solution**:
1. Review a few diffs to understand the change
2. If changes are correct, accept all new snapshots:
   ```bash
   # In Rider: Use "Accept All" if available
   # Or manually:
   find Snapshots -name "*.received.txt" | while read f; do
     mv "$f" "${f/.received./.verified.}"
   done
   ```
3. Commit updated snapshots

### Scenario 2: One Test Fails Unexpectedly

**Cause**: Regression in generator

**Solution**:
1. Review the diff carefully
2. Identify what changed
3. Fix the generator code
4. Rerun test to verify fix

### Scenario 3: New Feature, Multiple New Tests

**Workflow**:
1. Write all tests first
2. Run them (all will fail - no snapshots yet)
3. Review all `.received.txt` files
4. Accept the correct ones
5. Fix any that are wrong
6. Commit all new snapshots

### Scenario 4: Snapshot Conflicts in Git

**Cause**: Multiple people modified generator

**Solution**:
1. Pull latest changes
2. Run tests locally
3. If tests fail, review diffs
4. Accept correct output
5. Commit merged snapshots

## Best Practices

### âœ… DO

- **Review every snapshot** before accepting
- **Commit snapshots** to version control
- **Test edge cases** (empty input, special chars)
- **Keep tests focused** - one scenario per test
- **Use descriptive names** - `GeneratesCorrectCodeForRecursiveGlob`
- **Run tests before committing** changes

### âŒ DON'T

- Don't blindly accept all snapshots
- Don't commit `.received.txt` files
- Don't skip reviewing diffs
- Don't test multiple scenarios in one test
- Don't ignore test failures in CI

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x
    
    - name: Restore
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore
    
    - name: Test
      run: dotnet test --no-build --verbosity normal
    
    # Tests fail if generated output doesn't match committed snapshots
```

### Azure Pipelines Example

```yaml
trigger:
- main

pool:
  vmImage: 'windows-latest'

steps:
- task: UseDotNet@2
  inputs:
    version: '10.0.x'

- task: DotNetCoreCLI@2
  displayName: 'Run Tests'
  inputs:
    command: 'test'
    projects: '**/*Tests.csproj'
```

## Troubleshooting

### Problem: Tests pass locally but fail in CI

**Causes:**
- Line ending differences (CRLF vs LF)
- File path differences (Windows vs Linux)
- Missing files in repository

**Solutions:**
- Configure `.editorconfig` for consistent line endings
- Use `Path.DirectorySeparatorChar` in generator
- Ensure all test files are committed

### Problem: Snapshots showing massive diffs

**Causes:**
- Generator output format changed significantly
- Whitespace/formatting changes

**Solutions:**
- Review changes carefully
- If intentional, accept new snapshots
- Consider using `VerifierSettings.ScrubEmptyLines()`

### Problem: Can't find generated .verified.txt files

**Causes:**
- Test hasn't run yet
- Snapshot directory not configured correctly

**Solutions:**
- Run tests first
- Check `Snapshots/` directory is being created
- Verify `VerifierSettings` in `ModuleInitializer.cs`

### Problem: Rider not showing diff tool

**Causes:**
- Verify plugin not installed
- Settings not configured

**Solutions:**
- Install "Verify Support" plugin in Rider
- Settings â†’ Tools â†’ Verify â†’ Enable

## Advanced Usage

### Custom Snapshot Directory

```csharp
// In ModuleInitializer.cs
VerifierSettings.DerivePathInfo(
    (sourceFile, projectDirectory, type, method) => 
        new PathInfo(
            directory: Path.Combine(projectDirectory, "CustomSnapshots"),
            typeName: type.Name,
            methodName: method.Name));
```

### Filtering Snapshot Content

```csharp
// Scrub sensitive data
VerifierSettings.ScrubLinesContaining("Password=");

// Ignore specific lines
VerifierSettings.ScrubLines(line => line.Contains("Timestamp"));
```

### Parameterized Tests

```csharp
[Theory]
[InlineData("config.json")]
[InlineData("appsettings.json")]
public Task GeneratesCorrectCodeForJsonFile(string filename)
{
    // ... test logic
    
    return TestHelper.Verify(projectContent, filename)
        .UseParameters(filename); // Creates separate snapshot per parameter
}
```

## Maintenance

### Regular Tasks

**Weekly:**
- Run full test suite
- Review any new test failures

**Per Release:**
- Review all snapshots
- Update docs if format changes
- Check CI/CD still passing

**When Adding Features:**
- Add tests for new functionality
- Update existing tests if needed
- Review all snapshot diffs

## Quick Reference

```bash
# Run all tests
dotnet test

# Run specific test
dotnet test --filter "FullyQualifiedName~TestName"

# Run with coverage
dotnet test /p:CollectCoverage=true

# Clean artifacts
dotnet clean

# Accept all snapshots (careful!)
# Review each file first, then:
find Snapshots -name "*.received.txt" -exec sh -c 'mv "$1" "${1/.received./.verified.}"' _ {} \;
```

## Further Reading

- [Verify Documentation](https://github.com/VerifyTests/Verify)
- [Verify.SourceGenerators](https://github.com/VerifyTests/Verify.SourceGenerators)
- [Source Generator Cookbook](https://github.com/dotnet/roslyn/blob/main/docs/features/source-generators.cookbook.md)
- [Snapshot Testing Best Practices](https://kentcdodds.com/blog/effective-snapshot-testing)

---

**Happy Testing!** ğŸ§ª Remember: snapshot tests are only as good as the snapshots you approve.
